name: ğŸš€ Stilya Fashion AI - Complete CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AZURE_RESOURCE_GROUP: rg-stilya-fashion-ai
  AZURE_CONTAINER_REGISTRY: stilyaacr
  IMAGE_NAME: stilya-fashion-ai
  
jobs:
  # 1. Kod Kalitesi ve Test
  quality-check:
    name: ğŸ” Code Quality & Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r dev-requirements.txt || echo "No dev requirements"
        
    - name: ğŸ§¹ Code Formatting Check
      run: |
        black --check src/ || echo "Formatting issues found"
        isort --check-only src/ || echo "Import sorting issues found"
        
    - name: ğŸ” Linting
      run: |
        pylint src/stilya/ || echo "Linting issues found"
        mypy src/stilya/ || echo "Type checking issues found"
        
    - name: ğŸ§ª Run Tests
      run: |
        python test_stilya.py
        pytest tests/ || echo "Some tests may require external services"
        
    - name: ğŸ“Š Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: test-results/

  # 2. Docker Build
  build-image:
    name: ğŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: ğŸ³ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ—ï¸ Build and Push Docker Image
      run: |
        # Build image
        docker build -t ${{ env.IMAGE_NAME }}:${{ github.sha }} .
        docker build -t ${{ env.IMAGE_NAME }}:latest .
        
        # Tag for ACR
        docker tag ${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
        
        # Login to ACR and push
        az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}
        docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest

  # 3. Infrastructure Deployment
  deploy-infrastructure:
    name: ğŸ—ï¸ Deploy Azure Infrastructure
    runs-on: ubuntu-latest
    needs: build-image
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: ğŸ—ï¸ Deploy ARM Template
      run: |
        az deployment group create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --template-file deploy/azure/infrastructure.json \
          --parameters \
            appName=stilya-fashion-ai \
            environment=${{ github.event.inputs.environment || 'dev' }} \
            containerImage=${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            minReplicas=2 \
            maxReplicas=10

  # 4. Application Deployment
  deploy-application:
    name: ğŸš€ Deploy Application
    runs-on: ubuntu-latest
    needs: [build-image, deploy-infrastructure]
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: ğŸ” Update Key Vault Secrets
      run: |
        # Get Key Vault name from deployment
        KEY_VAULT_NAME=$(az keyvault list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "[0].name" -o tsv)
        
        # Update secrets (only if provided)
        if [ ! -z "${{ secrets.OPENAI_API_KEY }}" ]; then
          az keyvault secret set --vault-name $KEY_VAULT_NAME --name "openai-api-key" --value "${{ secrets.OPENAI_API_KEY }}"
        fi
        
        if [ ! -z "${{ secrets.AZURE_CLIENT_SECRET }}" ]; then
          az keyvault secret set --vault-name $KEY_VAULT_NAME --name "azure-client-secret" --value "${{ secrets.AZURE_CLIENT_SECRET }}"
        fi
        
    - name: ğŸ”„ Update Container App
      run: |
        # Get container app name
        CONTAINER_APP_NAME=$(az containerapp list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "[0].name" -o tsv)
        
        # Update container app with new image
        az containerapp update \
          --name $CONTAINER_APP_NAME \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --image ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          
    - name: ğŸ” Get Application URL
      run: |
        CONTAINER_APP_NAME=$(az containerapp list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "[0].name" -o tsv)
        APP_URL=$(az containerapp show --name $CONTAINER_APP_NAME --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)
        echo "ğŸŒ Application URL: https://$APP_URL"
        echo "APP_URL=https://$APP_URL" >> $GITHUB_ENV

  # 5. Health Check & Tests
  health-check:
    name: ğŸ¥ Health Check & Integration Tests
    runs-on: ubuntu-latest
    needs: deploy-application
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Test Dependencies
      run: |
        pip install requests pytest
        
    - name: ğŸ¥ Health Check
      run: |
        python -c "
        import requests
        import time
        import sys
        
        url = '${{ env.APP_URL }}/health'
        
        for i in range(30):  # 5 minutes timeout
            try:
                response = requests.get(url, timeout=10)
                if response.status_code == 200:
                    print('âœ… Health check passed!')
                    print(f'Response: {response.json()}')
                    sys.exit(0)
                else:
                    print(f'âš ï¸ Health check failed: {response.status_code}')
            except Exception as e:
                print(f'âš ï¸ Health check error: {e}')
            
            time.sleep(10)
        
        print('âŒ Health check timeout!')
        sys.exit(1)
        "
        
    - name: ğŸ§ª Integration Tests
      run: |
        python -c "
        import requests
        import json
        
        base_url = '${{ env.APP_URL }}'
        
        # Test recommendation endpoint
        test_request = {
            'user_id': 'test_user_ci',
            'occasion': 'business meeting',
            'preferences': {'style': 'professional'}
        }
        
        try:
            response = requests.post(f'{base_url}/recommend', json=test_request, timeout=30)
            print(f'ğŸ§ª Recommendation test: {response.status_code}')
            if response.status_code == 200:
                result = response.json()
                print(f'âœ… Recommendation successful: {result.get(\"confidence_score\", 0):.2f} confidence')
            else:
                print(f'âš ï¸ Recommendation failed: {response.text}')
        except Exception as e:
            print(f'âš ï¸ Integration test error: {e}')
        "

  # 6. Notification
  notify:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-application, health-check]
    if: always()
    
    steps:
    - name: ğŸ“¢ Success Notification
      if: needs.health-check.result == 'success'
      run: |
        echo "ğŸ‰ Stilya Fashion AI deployed successfully!"
        echo "ğŸŒ Application URL: ${{ env.APP_URL }}"
        echo "ğŸ“Š Health checks passed"
        echo "ğŸš€ Ready for users!"
        
    - name: ğŸ“¢ Failure Notification
      if: needs.health-check.result == 'failure'
      run: |
        echo "âŒ Deployment failed!"
        echo "ğŸ” Check logs for details"
        echo "ğŸ› ï¸ Manual intervention may be required"