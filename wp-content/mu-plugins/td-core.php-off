<?php
if ( ! defined('ABSPATH') ) exit;
/**
 * Treinador David Core MU-Plugin
 * Descrição: WCAG 2.2 AAA + Paleta AAA + Shortcodes (Quick Answer, Speakable, TOC, Science, Q&A, Signature) + Article/Speakable JSON-LD.
 * Autor: Treinador David
 * Versão: 1.1.0
 *
 * Notas:
 * - TOC com duas variações: lateral (default) e topo fixo (variant="top").
 *   Ex.: [td_toc]  (lateral)  |  [td_toc variant="top"]  (topo fixo)
 * - Lateral alinhada com início do conteúdo (top: 75px).
 */

/* -------------------------------------------------------------------------
 * 1) ACESSIBILIDADE & SCHEMA.ORG
 * ------------------------------------------------------------------------- */

// Skip link (TAB -> aparece; leva ao #main-content). Hook: wp_body_open.
add_action('wp_body_open', 'td_add_skip_link', 1);
function td_add_skip_link() {
	echo '<a href="#main-content" class="td-skip-link">Pular para o conteúdo</a>';
	echo "<script>
	document.addEventListener('DOMContentLoaded',function(){
		var skip=document.querySelector('.td-skip-link');
		if(!skip) return;
		skip.addEventListener('click',function(){
			var main=document.getElementById('main-content');
			if(main){ main.focus(); }
		});
	});
	</script>";
}

// JSON-LD Article + Speakable (quando [td_speakable] presente)
add_action('wp_head', 'td_output_schema_jsonld', 5);
function td_output_schema_jsonld() {
	if ( ! is_singular('post') ) return;

	$post_id    = get_queried_object_id();
	$post_url   = get_permalink($post_id);
	$post_title = get_the_title($post_id);

	$schema = array(
		'@context'  => 'https://schema.org',
		'@type'     => 'Article',
		'headline'  => wp_strip_all_tags($post_title),
		'url'       => esc_url($post_url),
		'author'    => array('@type' => 'Person', 'name' => 'Treinador David'),
		'publisher' => array(
			'@type' => 'Organization',
			'name'  => 'Treinador David',
			'logo'  => array('@type' => 'ImageObject','url' => 'https://treinadordavid.com/wp-content/uploads/2025/09/treinadord-david-icon.png')
		)
	);

	global $post;
	if ( $post && has_shortcode($post->post_content, 'td_speakable') ) {
		$schema['speakable'] = array(
			'@type'       => 'SpeakableSpecification',
			'cssSelector' => array('.td-speakable')
		);
	}

	echo '<script type="application/ld+json">' . wp_json_encode($schema, JSON_UNESCAPED_SLASHES|JSON_UNESCAPED_UNICODE) . '</script>';
}


/* -------------------------------------------------------------------------
 * 2) ESTILOS (PALETA AAA, TIPOGRAFIA, LAYOUT, SHORTCODES) + FONTES LOCAIS
 * ------------------------------------------------------------------------- */

add_action('wp_enqueue_scripts','td_enqueue_inline_styles',20);
function td_enqueue_inline_styles(){
	// handle "vazio" para receber CSS inline
	wp_register_style('td-core-inline-css', false, array(), '1.1', 'all');
	wp_enqueue_style('td-core-inline-css');

	$css  = '';
	$css .= ":root{--td-blue:#0EA5E9;--td-blue-aa:#0369A1;--td-blue-dark:#0B1220;--td-text:#0F172A;--td-text-2:#475569;--td-bg:#FFFFFF;--td-bg-2:#F8FAFC;--td-cta:#C2410C;--td-ok:#15803D;--td-err:#B91C1C}\n";
	$css .= "html{font-size:clamp(1rem,0.5vw+0.875rem,1.125rem);scroll-behavior:smooth}body{background:var(--td-bg);color:var(--td-text);line-height:1.7;font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif}h1,h2,h3,h4,h5,h6,.hero-title,.td-qa-q,.td-signature-text strong{font-family:'Oswald',Impact,'Arial Black',sans-serif}p{max-width:72ch}p+p{margin-top:20px}\n";
	$css .= ":focus-visible{outline:3px solid var(--td-blue);outline-offset:3px;border-radius:4px}a:focus,button:focus,input:focus,textarea:focus,select:focus{outline:3px solid var(--td-blue);outline-offset:3px;border-radius:4px}\n";
	$css .= ".td-skip-link{position:absolute;left:-999px;top:0;z-index:999;background:#0EA5E9;color:#fff;padding:8px 16px;border-radius:4px;text-decoration:none}.td-skip-link:focus{left:0;top:0}\n";

	// Layout artigo + TOC lateral
	$css .= ".post-wrapper{max-width:1200px;padding:0 20px;margin:0 auto}.layout-rail-right{display:grid;grid-template-columns:1fr 280px;gap:40px;align-items:start}.article-content{max-width:1000px}\n";
	$css .= ".rail{position:sticky;top:75px;align-self:start;background:#fff;border:3px solid var(--td-blue);border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.04)}.rail h3{margin-top:0}.rail ol{margin:0;padding-left:20px}.rail ol ol{margin-left:20px}.rail li{margin:4px 0}.rail a{color:var(--td-blue-aa);text-decoration:none}.rail a:hover{color:var(--td-blue-dark);text-decoration:underline}\n";
	$css .= "@media (max-width:960px){.layout-rail-right{grid-template-columns:1fr}.rail{display:none}}\n";

	// TOC variante "topo fixo" (inserido no fluxo do conteúdo, logo após o título)
	$css .= ".td-toc-top{position:sticky;top:0;z-index:10;background:#fff;border-bottom:3px solid var(--td-blue);padding:12px 16px;margin:0 0 24px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,.05)}.td-toc-top h3{font-family:'Oswald',Impact,'Arial Black',sans-serif;font-size:1.1rem;color:var(--td-blue-dark);margin:0 0 8px}\n";
	$css .= "@media (max-width:960px){.td-toc-top{position:relative;top:auto}}\n";

	// Quick Answer
	$css .= ".td-quick-answer{background:#F0F9FF;border-left:5px solid var(--td-blue);padding:20px;border-radius:8px;margin:24px 0}.td-quick-answer h4{margin-top:0}\n";
	// Speakable (neutro visual)
	$css .= ".td-speakable{display:block}\n";

	// Science cards (2 colunas desktop)
	$css .= ".td-articles-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:24px;margin:40px 0}@media (max-width:768px){.td-articles-grid{grid-template-columns:1fr}}\n";
	$css .= ".td-article-card{background:#fff;border:3px solid var(--td-blue);border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,.04);transition:transform .2s ease,box-shadow .2s ease}.td-article-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.10)}\n";
	$css .= ".td-article-title{font-family:'Oswald',Impact,'Arial Black',sans-serif;font-size:1.1rem;margin:0 0 8px}.td-article-meta{font-size:.9rem;color:var(--td-text-2);margin:0 0 8px}.td-article-reference{font-size:.9rem;font-style:italic;color:var(--td-text-2);margin:0 0 12px}.td-article-summary{font-size:.95rem;line-height:1.6;color:var(--td-text)}.td-sergeant-note{background:#0B1220;color:#fff;padding:14px;border-radius:8px;margin-top:16px;font-family:'Oswald',Impact,'Arial Black',sans-serif;font-size:.95rem}.td-sergeant-note b{color:var(--td-blue)}\n";

	// Q&A cards
	$css .= ".td-qa-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin:40px 0}.td-qa-card{background:#fff;border:3px solid var(--td-blue);border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,.04)}\n";
	$css .= ".td-qa-badge{display:inline-block;background:var(--td-blue);color:#fff;border-radius:999px;padding:4px 12px;font-size:.85rem;margin:0 0 8px}.td-qa-q{font-family:'Oswald',Impact,'Arial Black',sans-serif;font-size:1.15rem;font-weight:700;margin:0 0 8px}.td-qa-a{font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;font-size:.95rem;line-height:1.6;color:var(--td-text)}\n";
	$css .= ".td-qa-block .td-btn{display:inline-block;margin-top:16px;background:var(--td-blue-aa);color:#fff;padding:10px 16px;border-radius:4px;text-decoration:none}.td-qa-block .td-btn:hover{background:var(--td-blue-dark)}\n";

	// Signature
	$css .= ".td-signature-block{display:flex;align-items:center;gap:16px;padding:24px;background:var(--td-bg-2);border:2px solid var(--td-blue);border-radius:12px;margin:50px 0 30px}.td-signature-logo{width:80px;height:80px;border-radius:50%;border:3px solid var(--td-blue);flex-shrink:0}.td-signature-text strong{font-size:1.3rem;text-transform:uppercase;color:#0B1220}.td-signature-text span{font-size:.95rem;color:var(--td-text-2)}.td-signature-text .td-ai{color:var(--td-blue-aa);font-weight:600}\n";

	// Reduced motion
	$css .= "@media (prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:.01ms !important;transition-duration:.01ms !important;scroll-behavior:auto !important}}\n";

	// Fontes locais se ativado por constante
	if ( defined('TD_CORE_USE_LOCAL_FONTS') && TD_CORE_USE_LOCAL_FONTS ) {
		$inter  = esc_url( get_stylesheet_directory_uri() . '/fonts/Inter-Variable.woff2' );
		$oswald = esc_url( get_stylesheet_directory_uri() . '/fonts/Oswald-Variable.woff2' );
		$css .= "@font-face{font-family:'Inter';src:url('{$inter}') format('woff2');font-weight:100 900;font-display:swap}\n";
		$css .= "@font-face{font-family:'Oswald';src:url('{$oswald}') format('woff2');font-weight:200 700;font-display:swap}\n";
	}

	// Minificar e injetar
	$css_min = preg_replace('/\s+/', ' ', $css);
	$css_min = str_replace('; ', ';', $css_min);
	wp_add_inline_style('td-core-inline-css', trim($css_min));
}


// 3. FILTRO DE CONTEÚDO: ADICIONAR IDs EM HEADINGS (para TOC) — corrigido p/ H2–H4 e HTML bem‑formado
add_filter('the_content', 'td_filter_add_heading_ids', 8);
function td_filter_add_heading_ids($content) {
    if ( !is_singular('post') ) {
        return $content;
    }

    // Armazena headings p/ o TOC
    global $td_toc_headings;
    $td_toc_headings = array();

    // Captura <h2>, <h3>, <h4> (case-insensitive, multiline)
    $content = preg_replace_callback('/<h([2-4])\b([^>]*)>(.*?)<\/h\1>/is', function($m) {
        global $td_toc_headings;

        $level = (int) $m[1];
        $attrs = $m[2];
        $inner = $m[3];

        // Se já houver id, preserva; senão cria único a partir do texto
        if (preg_match('/\bid\s*=\s*"(.*?)"/i', $attrs, $idMatch)) {
            $idVal = trim($idMatch[1]);
        } else {
            $text   = trim( wp_strip_all_tags($inner) );
            $baseId = sanitize_title($text);
            $idVal  = $baseId ?: 'secao';
            $suffix = 2;
            $existing = array_column($td_toc_headings, 'id');
            while (in_array($idVal, $existing, true)) {
                $idVal = $baseId . '-' . $suffix++;
            }
            $attrs = trim($attrs);
            $attrs = ' id="'.$idVal.'"'.($attrs ? ' '.$attrs : '');
        }

        // Guarda no array global (usado pelo shortcode [td_toc])
        $td_toc_headings[] = array(
            'level' => $level,
            'id'    => $idVal,
            'text'  => wp_strip_all_tags($inner),
        );

        return '<h'.$level.$attrs.'>'.$inner.'</h'.$level.'>';
    }, $content);

    return $content;
}


/* -------------------------------------------------------------------------
 * 4) SHORTCODES
 * ------------------------------------------------------------------------- */

// [td_quick_answer title="..."]...[/td_quick_answer]
add_shortcode('td_quick_answer','td_shortcode_quick_answer');
function td_shortcode_quick_answer($atts,$content=null){
	$a = shortcode_atts(array('title'=>''), $atts, 'td_quick_answer');
	$out  = '<aside class="td-quick-answer" role="region" aria-label="Resposta rápida">';
	if ( ! empty($a['title']) ) $out .= '<h4>'.esc_html($a['title']).'</h4>';
	$out .= wp_kses_post($content);
	$out .= '</aside>';
	return $out;
}

// [td_speakable]...[/td_speakable]
add_shortcode('td_speakable','td_shortcode_speakable');
function td_shortcode_speakable($atts,$content=null){
	return '<div class="td-speakable" itemscope itemtype="https://schema.org/SpeakableSpecification">'. wp_kses_post($content) .'</div>';
}

// [td_toc title="Navegação Rápida" variant="lateral|top" min_level="2" max_level="4"]
add_shortcode('td_toc', 'td_shortcode_toc');
function td_shortcode_toc($atts, $content = null) {
    $a = shortcode_atts(array(
        'title'     => 'Navegação Rápida',
        'variant'   => 'lateral', // lateral | top
        'min_level' => 2,
        'max_level' => 4,
    ), $atts, 'td_toc');

    global $td_toc_headings;
    if (empty($td_toc_headings)) return '';

    $min = (int)$a['min_level'];
    $max = (int)$a['max_level'];

    // Headings apenas H2–H4
    $items = array_values(array_filter($td_toc_headings, function($h) use ($min,$max){
        $lvl = (int)$h['level'];
        return ($lvl >= $min && $lvl <= $max);
    }));
    if (empty($items)) return '';

    // Wrapper (lateral = .rail, topo = .td-toc-top)
    $wrapper_class = ($a['variant'] === 'top') ? 'td-toc-top' : 'rail';

    // Base e nível atual
    $base = (int)$items[0]['level'];
    $cur  = $base;

    $out  = '<aside class="'. esc_attr($wrapper_class) .'" role="complementary" aria-label="Índice">';
    if (!empty($a['title'])) {
        $out .= '<h3>'. esc_html($a['title']) .'</h3>';
    }
    $out .= '<nav class="td-toc-nav" aria-label="Tabela de conteúdos"><ol>';

    $first = true;
    foreach ($items as $h) {
        $lvl  = max($min, min($max, (int)$h['level']));
        $id   = esc_attr($h['id']);
        $text = esc_html($h['text']);

        if ($first) {
            $out   .= '<li><a href="#'.$id.'">'.$text.'</a>';
            $first  = false;
            $cur    = $lvl;
            continue;
        }

        if ($lvl > $cur) {
            for ($i=$cur; $i<$lvl; $i++) $out .= '<ol>';
            $out .= '<li><a href="#'.$id.'">'.$text.'</a>';
        } elseif ($lvl === $cur) {
            $out .= '</li><li><a href="#'.$id.'">'.$text.'</a>';
        } else {
            $out .= '</li>';
            for ($i=$cur; $i>$lvl; $i--) $out .= '</ol></li>';
            $out .= '<li><a href="#'.$id.'">'.$text.'</a>';
        }
        $cur = $lvl;
    }

    // Fecha pilha
    $out .= '</li>';
    for ($i=$cur; $i>$base; $i--) $out .= '</ol></li>';
    $out .= '</ol></nav></aside>';

    return $out;
}


    // Fecha o último item e toda a pilha de listas até a base
    $toc .= '</li>';
    for ($i = $current; $i > $base; $i--) {
        $toc .= '</ol></li>';
    }
    $toc .= '</ol></nav></aside>';

    return $toc;
}


// [td_science title="Evidência Científica"]...[/td_science]
add_shortcode('td_science','td_shortcode_science');
function td_shortcode_science($atts,$content=null){
	$a    = shortcode_atts(array('title'=>'Evidência Científica'), $atts, 'td_science');
	$out  = '<aside class="td-science-block" role="region" aria-label="'. esc_attr($a['title']) .'">';
	if ( ! empty($a['title']) ) $out .= '<h3>'. esc_html($a['title']) .'</h3>';
	$out .= '<div class="td-articles-grid">'. do_shortcode( wp_kses_post($content) ) .'</div></aside>';
	return $out;
}

// [td_qa title="Q&A do Treinador" cta_url="" cta_label=""]...[/td_qa]
add_shortcode('td_qa','td_shortcode_qa');
function td_shortcode_qa($atts,$content=null){
	$a = shortcode_atts(array('title'=>'Q&A do Treinador','cta_url'=>'','cta_label'=>''), $atts, 'td_qa');
	$out  = '<aside class="td-qa-block" role="region" aria-label="'. esc_attr($a['title']) .'">';
	if ( ! empty($a['title']) ) $out .= '<h3>'. esc_html($a['title']) .'</h3>';
	$out .= '<div class="td-qa-grid">'. do_shortcode( wp_kses_post($content) ) .'</div>';
	if ( ! empty($a['cta_url']) && ! empty($a['cta_label']) ) {
		$out .= '<p style="text-align:center;margin-top:20px"><a class="td-btn" href="'. esc_url($a['cta_url']) .'">'. esc_html($a['cta_label']) .'</a></p>';
	}
	$out .= '</aside>';
	return $out;
}

// [td_signature]
add_shortcode('td_signature','td_shortcode_signature');
function td_shortcode_signature($atts,$content=null){
	$img = 'https://treinadordavid.com/wp-content/uploads/2025/09/treinadord-david-icon.png';
	$out  = '<div class="td-signature-block">';
	$out .= '<img src="'. esc_url($img) .'" alt="Treinador David Logo" class="td-signature-logo" width="80" height="80" />';
	$out .= '<div class="td-signature-text"><strong>Treinador David</strong><br><span>Personal Trainer <span class="td-ai">| CREF 7-016401-G/DF</span></span></div>';
	$out .= '</div>';
	return $out;
}
